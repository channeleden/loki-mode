# Loki Mode Enterprise Workflow
# Triggers Loki Mode execution from GitHub events
# See: skills/github-integration.md for full documentation

name: Loki Mode Enterprise

on:
  issues:
    types: [labeled]

  pull_request_review:
    types: [submitted]

  # Schedule trigger (disabled by default)
  # Uncomment and configure the cron expression to enable
  # schedule:
  #   - cron: '0 6 * * 1'  # Example: Every Monday at 6:00 UTC

  workflow_dispatch:
    inputs:
      prd_content:
        description: 'PRD content or path to PRD file in the repository'
        required: true
        type: string
      provider:
        description: 'Loki Mode provider (claude, codex, gemini)'
        required: false
        default: 'claude'
        type: choice
        options:
          - claude
          - codex
          - gemini
      dry_run:
        description: 'Dry run mode (validate inputs without executing)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  loki-run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # For issue triggers, only run when the label is "loki-mode"
    # For PR review triggers, only run when the PR has a "loki-mode" label
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issues' && github.event.label.name == 'loki-mode') ||
      (github.event_name == 'pull_request_review' && contains(github.event.pull_request.labels.*.name, 'loki-mode'))

    outputs:
      execution_id: ${{ steps.execute.outputs.execution_id }}
      status: ${{ steps.execute.outputs.status }}
      report_path: ${{ steps.execute.outputs.report_path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install loki-mode
        run: npm install -g loki-mode

      - name: Parse trigger context
        id: context
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          INPUT_PRD_CONTENT: ${{ inputs.prd_content }}
          INPUT_PROVIDER: ${{ inputs.provider }}
          INPUT_DRY_RUN: ${{ inputs.dry_run }}
        run: |
          node -e "
          const handler = require('./src/integrations/github/action-handler.js');
          const fs = require('fs');
          const eventPayload = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
          const context = handler.parseTriggerContext({
            eventName: process.env.GITHUB_EVENT_NAME,
            payload: eventPayload,
            inputs: {
              prd_content: process.env.INPUT_PRD_CONTENT || '',
              provider: process.env.INPUT_PROVIDER || 'claude',
              dry_run: process.env.INPUT_DRY_RUN === 'true'
            }
          });
          // Write outputs
          const outputFile = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(outputFile, 'prd=' + JSON.stringify(context.prd) + '\n');
          fs.appendFileSync(outputFile, 'trigger_type=' + context.triggerType + '\n');
          fs.appendFileSync(outputFile, 'provider=' + context.provider + '\n');
          fs.appendFileSync(outputFile, 'dry_run=' + (context.dryRun ? 'true' : 'false') + '\n');
          fs.appendFileSync(outputFile, 'source_id=' + (context.sourceId || '') + '\n');
          fs.appendFileSync(outputFile, 'source_type=' + (context.sourceType || '') + '\n');
          "

      - name: Verify actor trust for fork PRs
        if: >-
          github.event_name == 'pull_request_review' &&
          github.event.pull_request.head.repo.full_name != github.repository
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          FORK_SOURCE: ${{ github.event.pull_request.head.repo.full_name }}
        run: |
          # Reject execution when the PR originates from a fork
          # to prevent untrusted code from running with write permissions
          echo "Skipping execution: pull_request_review from a fork repository is not trusted."
          printf 'PR author: %s\n' "$PR_AUTHOR"
          printf 'Fork source: %s\n' "$FORK_SOURCE"
          exit 1

      - name: Execute Loki Mode
        id: execute
        if: steps.context.outputs.dry_run != 'true'
        env:
          LOKI_PROVIDER: ${{ steps.context.outputs.provider }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PRD_CONTENT: ${{ steps.context.outputs.prd }}
        run: |
          EXECUTION_ID="loki-$(date +%s)"
          echo "execution_id=${EXECUTION_ID}" >> $GITHUB_OUTPUT

          # Write PRD content to temp file via env variable (prevents shell injection)
          PRD_FILE=$(mktemp /tmp/loki-prd-XXXXXX.md)
          printf '%s' "$PRD_CONTENT" > "$PRD_FILE"

          # Execute Loki Mode - capture exit code via PIPESTATUS (not grep on output)
          set +e
          loki start --provider "$LOKI_PROVIDER" "$PRD_FILE" 2>&1 | tee /tmp/loki-output.log
          LOKI_EXIT=${PIPESTATUS[0]}
          set -e

          # Determine status from loki exit code (reliable signal)
          if [ "$LOKI_EXIT" -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

          echo "report_path=.loki/reports" >> $GITHUB_OUTPUT

          # Cleanup
          rm -f "$PRD_FILE"

      - name: Upload execution artifacts
        if: steps.context.outputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: loki-execution-${{ steps.execute.outputs.execution_id }}
          path: |
            .loki/reports/
            .loki/state/
          if-no-files-found: ignore

  report:
    runs-on: ubuntu-latest
    needs: loki-run
    if: always() && needs.loki-run.result != 'skipped'
    permissions:
      issues: write
      pull-requests: write
      statuses: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download execution artifacts
        uses: actions/download-artifact@v4
        with:
          name: loki-execution-${{ needs.loki-run.outputs.execution_id }}
          path: .loki/
        continue-on-error: true

      - name: Post results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          EXECUTION_STATUS: ${{ needs.loki-run.outputs.status }}
          EXECUTION_ID: ${{ needs.loki-run.outputs.execution_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          node -e "
          const reporter = require('./src/integrations/github/reporter.js');
          const fs = require('fs');
          const eventPayload = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));

          (async () => {
            try {
              await reporter.postResults({
                eventName: process.env.GITHUB_EVENT_NAME,
                payload: eventPayload,
                status: process.env.EXECUTION_STATUS || 'unknown',
                executionId: process.env.EXECUTION_ID || 'unknown',
                repository: process.env.GITHUB_REPOSITORY,
                sha: process.env.GITHUB_SHA,
                serverUrl: process.env.GITHUB_SERVER_URL,
                runId: process.env.GITHUB_RUN_ID,
                token: process.env.GITHUB_TOKEN,
                reportsPath: '.loki/reports'
              });
            } catch (err) {
              console.error('Reporter error:', err.message);
              process.exit(1);
            }
          })();
          "
